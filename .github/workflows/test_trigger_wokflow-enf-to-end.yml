name: Test Trigger Workflow End-to-End
on:
  push:
    branches:
      - feature/Create-workflow-to-trigger-e2e-tests


  workflow_run:
    workflows: ["Build And Test Code in Sonar Cloud"]
    types:
      - completed

jobs:
  trigger_e2e_tests:
    name: Trigger Run End-to-End Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis

      - name: Install Dependencies
        run: |
          npm install npm@latest
          npm install @octokit/core
          npm install
        continue-on-error: false

      - name: Trigger Workflow
        uses: actions/github-script@v6
        with:
          script: |
              const { Octokit } = require("@octokit/core");
              const octokit = new Octokit({
                auth: "${{ secrets.TRIGGER_TOKEN }}"
              });

              const response = await octokit.request('POST /repos/${{ github.repository_owner }}/${{ github.repository }}/actions/workflows/Tests_e2e.yml', {
                owner: "${{ github.repository_owner }}",
                repo: "${{ github.repository }}",
                workflow_id: "${{ github.run_id }}",
                ref: "${{ github.workflow_ref }}",
                inputs: {
                  e2e_test_input: 'run'
                },
                headers: {
                  'X-GitHub-Api-Version': '2022-11-28'
                }
              });
              console.log(response);
